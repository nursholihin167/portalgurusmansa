<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru - Full Fitur</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #eef; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0 15px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Tombol Utama */
        button { padding: 10px 20px; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-submit { background: #28a745; width: 100%; }
        .btn-submit:hover { background: #218838; }
        
        /* Tombol Aksi di List */
        .btn-edit { background: #ffc107; color: #333; margin-right: 5px; padding: 5px 10px; font-size: 14px; }
        .btn-delete { background: #dc3545; padding: 5px 10px; font-size: 14px; color: white; }
        .btn-cancel { background: #6c757d; display: none; margin-top: 10px; width: 100%; }

        .item-materi { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .item-info h4 { margin: 0 0 5px; }
        .item-info p { margin: 0; color: #666; font-size: 0.9em; }
        
        .warning { color: red; text-align: center; display: none; padding: 20px; background: white; margin-top: 20px; border-radius: 8px; }
        #loading-text { text-align: center; color: #666; margin-top: 20px; }
    </style>
</head>
<body>

    <h2>üë®‚Äçüè´ Dashboard Admin</h2>
    <p id="loading-text">Sedang memuat sistem...</p>

    <div id="msg-error" class="warning">
        <h3>‚õî AKSES DITOLAK</h3>
        <p>Email Anda tidak terdaftar sebagai Guru.</p>
        <p>Silakan login dengan akun yang benar di halaman depan.</p>
        <a href="../index.html">Kembali ke Depan</a>
    </div>

    <div id="form-area" class="card" style="display:none;">
        <p>Login sebagai: <b id="email-guru">...</b></p>
        <hr>
        
        <form id="formMateri">
            <input type="hidden" id="doc-id"> <label>Judul Materi</label>
            <input type="text" id="judul" required placeholder="Contoh: Bab 1 Matematika">

            <label>Deskripsi</label>
            <textarea id="deskripsi" rows="3" required placeholder="Instruksi untuk siswa..."></textarea>

            <label>Link File / Video</label>
            <input type="url" id="link" required placeholder="https://...">

            <button type="submit" id="btn-save" class="btn-submit">üöÄ Terbitkan Materi</button>
            <button type="button" id="btn-cancel" class="btn-cancel">Batal Edit (Kembali Tambah Baru)</button>
        </form>
    </div>

    <div id="list-area" class="card" style="display:none;">
        <h3>üìÇ Kelola Materi Anda</h3>
        <div id="materi-list">
            <p>Memuat data...</p>
        </div>
    </div>

    <script type="module">
        import { auth, db } from '../js/firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // PERBAIKAN: getDoc sudah saya masukkan di sini (paling atas)
        import { collection, addDoc, serverTimestamp, deleteDoc, updateDoc, doc, query, orderBy, onSnapshot, getDoc } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- ‚ö†Ô∏è GANTI EMAIL GURU DI BAWAH INI ---
        const EMAIL_GURU = "dewiayurengganis2@gmail.com"; 
        // ----------------------------------------

        const formArea = document.getElementById('form-area');
        const listArea = document.getElementById('list-area');
        const msgError = document.getElementById('msg-error');
        const loadingText = document.getElementById('loading-text');
        const materiList = document.getElementById('materi-list');
        
        const form = document.getElementById('formMateri');
        const inputJudul = document.getElementById('judul');
        const inputDeskripsi = document.getElementById('deskripsi');
        const inputLink = document.getElementById('link');
        const inputId = document.getElementById('doc-id');
        const btnSave = document.getElementById('btn-save');
        const btnCancel = document.getElementById('btn-cancel');

        // 1. CEK LOGIN
        onAuthStateChanged(auth, (user) => {
            loadingText.style.display = 'none'; // Sembunyikan loading
            
            if (user && user.email === EMAIL_GURU) {
                // Jika Guru Asli
                formArea.style.display = 'block';
                listArea.style.display = 'block';
                document.getElementById('email-guru').innerText = user.email;
                loadMateriAdmin(); 
            } else {
                // Jika Bukan Guru / Belum Login
                msgError.style.display = 'block';
                formArea.style.display = 'none';
                listArea.style.display = 'none';
            }
        });

        // 2. LOAD DATA REALTIME
        function loadMateriAdmin() {
            const q = query(collection(db, "materi"), orderBy("tanggal_upload", "desc"));
            
            onSnapshot(q, (snapshot) => {
                materiList.innerHTML = ""; 
                if(snapshot.empty) { 
                    materiList.innerHTML = "<p>Belum ada materi. Silakan upload di atas.</p>"; 
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item-materi';
                    itemDiv.innerHTML = `
                        <div class="item-info">
                            <h4>${data.judul}</h4>
                            <p>${data.deskripsi ? data.deskripsi.substring(0, 50) + '...' : ''}</p>
                        </div>
                        <div>
                            <button class="btn-edit" data-id="${id}">Edit</button>
                            <button class="btn-delete" data-id="${id}">Hapus</button>
                        </div>
                    `;
                    materiList.appendChild(itemDiv);
                });

                // Pasang Event Listener Tombol
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', (e) => hapusMateri(e.target.dataset.id));
                });
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', (e) => modeEdit(e.target.dataset.id));
                });
            });
        }

        // 3. LOGIKA SIMPAN (BARU / UPDATE)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idEdit = inputId.value; 

            const dataBaru = {
                judul: inputJudul.value,
                deskripsi: inputDeskripsi.value,
                link_file: inputLink.value
            };

            btnSave.innerText = "‚è≥ Sedang Memproses...";
            btnSave.disabled = true;

            try {
                if(!idEdit) {
                    // Tambah Baru
                    dataBaru.tanggal_upload = serverTimestamp();
                    await addDoc(collection(db, "materi"), dataBaru);
                    alert("‚úÖ Materi Berhasil Ditambahkan!");
                } else {
                    // Update
                    await updateDoc(doc(db, "materi", idEdit), dataBaru);
                    alert("‚úÖ Materi Berhasil Diperbarui!");
                    resetForm();
                }
                form.reset();
            } catch (error) {
                alert("Gagal: " + error.message);
            } finally {
                btnSave.disabled = false;
                if(!inputId.value) btnSave.innerText = "üöÄ Terbitkan Materi";
            }
        });

        // 4. FUNGSI HAPUS
        async function hapusMateri(id) {
            if(confirm("‚ö†Ô∏è Yakin ingin menghapus materi ini selamanya?")) {
                try {
                    await deleteDoc(doc(db, "materi", id));
                } catch (error) {
                    alert("Gagal: " + error.message);
                }
            }
        }

        // 5. MASUK MODE EDIT
        async function modeEdit(id) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Ambil data detail
            try {
                const docSnap = await getDoc(doc(db, "materi", id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Isi form dengan data lama
                    inputId.value = id;
                    inputJudul.value = data.judul;
                    inputDeskripsi.value = data.deskripsi;
                    inputLink.value = data.link_file;

                    // Ubah tampilan tombol
                    btnSave.innerText = "üíæ Simpan Perubahan";
                    btnSave.style.background = "#ffc107"; // Kuning
                    btnSave.style.color = "black";
                    btnCancel.style.display = "block";
                }
            } catch (error) {
                console.error("Gagal ambil data edit", error);
            }
        }

        // 6. BATAL EDIT
        btnCancel.addEventListener('click', resetForm);

        function resetForm() {
            inputId.value = "";
            form.reset();
            btnSave.innerText = "üöÄ Terbitkan Materi";
            btnSave.style.background = "#28a745"; // Hijau kembali
            btnSave.style.color = "white";
            btnCancel.style.display = "none";
        }
    </script>
</body>
</html>
